# NAME: Proofpoint.ps1
# Version: 1.1
# AUTHOR: Matthew Snurkowski 
# DATE: 09/11/2021
# Updated: 6/21/2022
# ChangeLog: Added bypass to antispam policies
# DESCRIPTION: Sets Necessary IP addresses for bypassing SPAM rules in EXO. Adds New connector from Proofpoint IP Addresses.


Import-Module ExchangeOnlineManagement
$UPN = Read-Host -Prompt 'Enter Domain User'
Connect-ExchangeOnline -UserPrincipalName $UPN
write-host "Creating O365 Spam byPass"
New-TransportRule "ProofPoint Bypass" -SenderIpRanges "67.231.144.0/24","67.231.145.0/24","67.231.146.0/24","67.231.147.0/24","67.231.148.0/24","67.231.149.0/24","67.231.152.0/24","67.231.153.0/24","67.231.154.0/24","67.231.155.0/24","67.231.156.0/24","167.231.149.0/24","148.163.128.0/24","148.163.129.0/24","148.163.130.0/24","148.163.131.0/24","148.163.132.0/24","148.163.133.0/24","148.163.134.0/24","148.163.135.0/24","148.163.136.0/24","148.163.137.0/24","148.163.138.0/24","148.163.139.0/24","148.163.140.0/24","148.163.141.0/24","148.163.142.0/24","148.163.143.0/24","148.163.144.0/24","148.163.145.0/24","148.163.146.0/24","148.163.147.0/24","148.163.148.0/24","148.163.149.0/24","148.163.150.0/24","148.163.151.0/24","148.163.152.0/24","148.163.153.0/24","148.163.154.0/24","148.163.155.0/24","148.163.156.0/24","148.163.157.0/24","148.163.158.0/24","148.163.159.0/24" -SetSCL "-1" -Priority 0
Write-Host "Adding Spambrella IP to bypass antispam policies"
Set-HostedConnectionFilterPolicy “Default” -IPAllowList 67.231.144.0/24,67.231.145.0/24,67.231.146.0/24,67.231.147.0/24,67.231.148.0/24,67.231.149.0/24,67.231.152.0/24,67.231.153.0/24,67.231.154.0/24,67.231.155.0/24,67.231.156.0/24,167.231.149.0/24,148.163.128.0/24,148.163.129.0/24,148.163.130.0/24,148.163.131.0/24,148.163.132.0/24,148.163.133.0/24,148.163.134.0/24,148.163.135.0/24,148.163.136.0/24,148.163.137.0/24,148.163.138.0/24,148.163.139.0/24,148.163.140.0/24,148.163.141.0/24,148.163.142.0/24,148.163.143.0/24,148.163.144.0/24,148.163.145.0/24,148.163.146.0/24,148.163.147.0/24,148.163.148.0/24,148.163.149.0/24,148.163.150.0/24,148.163.151.0/24,148.163.152.0/24,148.163.153.0/24,148.163.154.0/24,148.163.155.0/24,148.163.156.0/24,148.163.157.0/24,148.163.158.0/24,148.163.159.0/24
write-host "Creating Inbound Connector"
New-InboundConnector -Name "Inbound Connector for Spambrella" -SenderDomains * -SenderIPAddresses "67.231.144.0/24","67.231.145.0/24","67.231.146.0/24","67.231.147.0/24","67.231.148.0/24","67.231.149.0/24","67.231.152.0/24","67.231.153.0/24","67.231.154.0/24","67.231.155.0/24","67.231.156.0/24","167.231.149.0/24","148.163.128.0/24","148.163.129.0/24","148.163.130.0/24","148.163.131.0/24","148.163.132.0/24","148.163.133.0/24","148.163.134.0/24","148.163.135.0/24","148.163.136.0/24","148.163.137.0/24","148.163.138.0/24","148.163.139.0/24","148.163.140.0/24","148.163.141.0/24","148.163.142.0/24","148.163.143.0/24","148.163.144.0/24","148.163.145.0/24","148.163.146.0/24","148.163.147.0/24","148.163.148.0/24","148.163.149.0/24","148.163.150.0/24","148.163.151.0/24","148.163.152.0/24","148.163.153.0/24","148.163.154.0/24","148.163.155.0/24","148.163.156.0/24","148.163.157.0/24","148.163.158.0/24","148.163.159.0/24" -Enabled $False -RequireTls $True
write-host "Creating Outbound Connector"
New-OutboundConnector -Name "Outbound Connector for Spambrella" -RecipientDomains *   -SmartHosts "outbound-us1.ppe-hosted.com" -Enabled $False -TlsSettings EncryptionOnly -UseMXRecord $False
write-host "Validating Outbound Connector"
Validate-OutboundConnector -Identity "Outbound Connector for Spambrella" -Recipients matt@peachstatetechnology.com
Pause